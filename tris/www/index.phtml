<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	
	<link rel="stylesheet" href="//code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css">
	<script src="//code.jquery.com/jquery-1.10.2.js"></script>
	<script src="//code.jquery.com/ui/1.11.3/jquery-ui.js"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&v=3&libraries=geometry"></script>

	<script>

		<!-- generate the "var urlString = '...'" -->
		<?php

    		$ini = parse_ini_file( "tris.ini", true );

    		$webprotocol = $ini["web"]["webprotocol"];
    		$webhost = $ini["web"]["webhost"];
    		$webpath = $ini["web"]["webpath"];
    	
			echo "var urlString = '" . $webprotocol . $webhost . $webpath ."';";
		?>

		var map;
		var infoWindows = [];  //For keep track of opened Info Windows
			
		/**
		* It Initializes the MAP
		* Size, position, markers
		*/
		function initialize() {
			var mapProp = {
			    center:new google.maps.LatLng(47.214688, 19.606562),
			    zoom:7,
			    mapTypeId:google.maps.MapTypeId.ROADMAP
			};
			map = new google.maps.Map(document.getElementById("map_canvas"),mapProp);
		
			$.ajax({
				type: "GET",
				url: urlString + "get_excursion_list.php",
				contentType: "text/html",
				dataType: "xml",
				async:true,
				success: getExcursionListSuccess,
				error: getError
			});
		}

		/**
		* Get Excursions and show them in table
		*/		
		function getExcursionListSuccess( data, status, req ){

			if( status =="success"){	

				//<excursion id= "" name="" dateStart="" dateEnd="">
				$(data).find("excursion").each(function(){

					//id
					excursionId = $(this).attr("id");
					excursionName = $(this).attr("name");
					excursionDateStart = $(this).attr("dateStart");
					excursionDateEnd = $(this).attr("dateEnd");

					$('#excursionList').append("<tr><td><div id='" + excursionId + "'>" + excursionName + "</div></td><td>" + excursionDateStart.substring(0, 4) + "</td></tr>");
					$( "#" + excursionId ).click(function() {
						//$( this ).slideUp();
						$.ajax({
							type: "GET",
							url: urlString + "get_details_by_excursion_id.php",
							data: { 'excursionid': excursionId, 'valami': "hello" },
							contentType: "text/html",
							dataType: "xml",
							async:true,
							success: getDetailsByExcursionIdSuccess,
							error: getError
						});
					});
					
				});
			}
		}

		function getDetailsByExcursionIdSuccess( data, status, req ){

			if( status =="success"){

				//<tour id="" type="">
				$(data).find("tour").each(function(){
					tourId = $(this).attr("id");
					tourType = $(this).attr("type");

					//The route path is empty
					var routePathArray = new Array();
					var preLatLong = null;
					var tourLength = 0;
				
					//<route lat="" lng="" time="">
					$(this).find("route").each(function(){
						routeLat = parseFloat( $(this).attr("lat") );
						routeLng = parseFloat( $(this).attr("lng") );
						routeTime = $(this).find("time").text();
						routeLatLong = new google.maps.LatLng(routeLat, routeLng);
						if( preLatLong != null ){
							routeDistance = google.maps.geometry.spherical.computeDistanceBetween (preLatLong, routeLatLong);
							tourLength += routeDistance;
						}
						preLatLong = routeLatLong;
						
						//Add new section to the route path
						routePathArray[routePathArray.length] = new google.maps.LatLng( routeLat, routeLng );
						 
					});

					//Tour path
					var routePath = new google.maps.Polyline({
						path: routePathArray,
						strokeColor: "#0000FF",
						strokeOpacity: 0.5,
						strokeWeidht: 5
					});
					routePath.setMap(map);
											
					var infoWindow = new google.maps.InfoWindow({
						content: excursionName + " túra<br>Hossza: " + tourLength.toFixed(2) + " m",
						excursionId: excursionId,
						tourId: tourId
					});

					infoWindows.push( infoWindow );

					//In case of Click on the path, an Info Window appears
					google.maps.event.addListener(routePath, 'click', function(event) {
						mLat = event.latLng.lat();
	                    mLng = event.latLng.lng();
	                    
						//Close all opened Info Window
						for (var i=0;i<infoWindows.length;i++) {
							infoWindows[i].close();
						}
						infoWindow.setPosition(event.latLng);
						infoWindow.open(map)	
					});
					
				});

				//<accomodation accomodation_id="" accomodation_name="" accomodation_type="" accomodation_address="" accomodation_lat="" accomodation_lng="">
				$(data).find("accomodation").each(function(){
					accomodationId = $(this).attr("accomodation_id");
					accomodationName = $(this).attr("accomodation_name");
					accomodationType = $(this).attr("accomodation_type");
					accomodationAddress = $(this).attr("accomodation_address");
					accomodationLat = $(this).attr("accomodation_lat");
					accomodationLng = $(this).attr("accomodation_lng");

					var marker = new google.maps.Marker({
						position: new google.maps.LatLng( accomodationLat, accomodationLng ),
						map: map,
					});

					var infoWindow = new google.maps.InfoWindow({
						content: accomodationName + "<br>Cím: " + accomodationAddress + "<br>Típus: " + accomodationType,
						excursionId: excursionId,
						tourId: tourId
					});

					infoWindows.push( infoWindow );

					//In case of Click on the path, an Info Window appears
					google.maps.event.addListener(marker, 'click', function(event) {
//						mLat = event.latLng.lat();
//	                    mLng = event.latLng.lng();
	                    
						//Close all opened Info Window
						for (var i=0;i<infoWindows.length;i++) {
							infoWindows[i].close();
						}
//						infoWindow.setPosition(event.latLng);
						infoWindow.open(map)	
					});

					//Arrange it to center
					//var center = new google.maps.LatLng(accomodationLat, accomodationLng);
				    //map.panTo(center);				
					
				});	

							
			}
		}

		function getError( data, status, req ){
			alert( 'Hiba az ajax híváskor: \n' + data.responseText ); // + '\nstatus: ' + status + '\n' + 'req: ' + req.responseText);
		}

		$(function() {

			$("#resize_canvas").resizable({
	      		"resize" : function(event,ui) {
	            	google.maps.event.trigger(map,'resize')
	      		}
			});
		});
		
		google.maps.event.addDomListener(window, 'load', initialize);

	</script>
</head>

<body>

	<table border="1">
		<tr>
			
			<td>
				<div id="resize_canvas" class="ui-widget-content" style="padding:0px;border:0;width:700px;height:450px;" >
					<div id="map_canvas" class="ui-widget-content" style="width:100%;height:100%;" ></div>				
				</div>
			</td>

			<td valign="top">
				<table border="2" id="excursionList">
					<tr>
						<th>Kirándulás</th>
						<th>Év</th>
					</tr>
				</table>
			</td>
		</tr>
	</table>
</body>

</html> 




